<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#fef3c7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Treehouse Games">
    <title>Treehouse Games</title>

    <!-- Core Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="manifest" href="manifest.json">

    <style>
        /* RESET & BASE */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #fef3c7; font-family: system-ui, -apple-system, sans-serif; user-select: none; touch-action: manipulation; }
        #root { width: 100%; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* 3D BUTTONS */
        .btn-3d { transition: all 0.1s; box-shadow: 0px 8px 0px 0px rgba(0,0,0,0.2); transform: translateY(0); cursor: pointer; }
        .btn-3d:active { transform: translateY(8px); box-shadow: 0px 0px 0px 0px rgba(0,0,0,0); }

        /* REALISTIC 3D EMOJI EFFECT */
        .emoji-3d {
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.3));
            transform: perspective(500px) rotateX(10deg);
            transition: transform 0.3s;
        }

        /* STORY HIGHLIGHT */
        .word-span { padding: 4px 6px; border-radius: 6px; transition: background-color 0.2s; }
        .word-active { background-color: #facc15; transform: scale(1.1); display: inline-block; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* DANCE ANIMATIONS - EXAGGERATED */
        @keyframes dance-jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-40px) scaleY(0.9); } }
        @keyframes dance-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes dance-wiggle { 0% { transform: rotate(-15deg); } 50% { transform: rotate(15deg); } 100% { transform: rotate(-15deg); } }
        @keyframes dance-stretch { 0%, 100% { transform: scale(1, 1); } 50% { transform: scale(1.3, 0.7); } }
        
        .d-jump { animation: dance-jump 0.6s ease-in-out infinite; }
        .d-spin { animation: dance-spin 1s linear infinite; }
        .d-wiggle { animation: dance-wiggle 0.5s ease-in-out infinite; }
        .d-stretch { animation: dance-stretch 0.6s ease-in-out infinite; }
        
        /* WAND FLOAT */
        @keyframes wandFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-10px) rotate(5deg); } }

        /* LOADING SCREEN */
        #loading {
            position: fixed; inset: 0; z-index: 10000;
            background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #020617 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fde047; transition: opacity 0.5s;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <div id="loading">
        <div style="position: relative; width: 250px; height: 250px; margin-bottom: 20px;">
            <!-- Realistic Wood Wand SVG -->
            <svg viewBox="0 0 300 300" fill="none" xmlns="http://www.w3.org/2000/svg" style="animation: wandFloat 4s ease-in-out infinite; filter: drop-shadow(0 20px 30px rgba(0,0,0,0.6));">
                <defs>
                    <filter id="woodGrain">
                        <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" result="noise"/>
                        <feColorMatrix type="matrix" values="0 0 0 0 0.4  0 0 0 0 0.25  0 0 0 0 0.1  0 0 0 1 0" in="noise" result="coloredNoise"/>
                        <feComposite operator="in" in="coloredNoise" in2="SourceGraphic" result="composite"/>
                        <feBlend mode="multiply" in="composite" in2="SourceGraphic"/>
                    </filter>
                    <radialGradient id="tipGlow" cx="0.5" cy="0.5" r="0.5">
                        <stop offset="0%" stop-color="#fef08a" stop-opacity="1"/>
                        <stop offset="100%" stop-color="#fef08a" stop-opacity="0"/>
                    </radialGradient>
                </defs>
                
                <!-- Wand Body -->
                <g transform="rotate(-45 150 150)">
                     <!-- Handle -->
                    <path d="M135 220 C125 240 175 240 165 220 L160 180 L140 180 Z" fill="#3e2723"/>
                    <ellipse cx="150" cy="190" rx="12" ry="5" fill="#271c19"/>
                    <ellipse cx="150" cy="210" rx="14" ry="6" fill="#271c19"/>
                    
                    <!-- Shaft with Taper -->
                    <path d="M140 180 L145 50 L155 50 L160 180 Z" fill="#5d4037" filter="url(#woodGrain)"/>
                    
                    <!-- Highlights -->
                    <path d="M148 50 L144 180" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>
                </g>
                
                <!-- Magic Tip Effect -->
                <circle cx="80" cy="80" r="20" fill="url(#tipGlow)" style="mix-blend-mode: screen; animation: pulse 1.5s infinite"/>
                <circle cx="80" cy="80" r="8" fill="white"/>
            </svg>
        </div>
        <div id="loading-text" style="font-size: 24px; font-family: serif; letter-spacing: 2px; text-shadow: 0 0 10px #FDE047;">Initializing Magic...</div>
        <button id="start-btn" style="display: none; margin-top: 30px; background: #eab308; color: #422006; border: 4px solid #fef08a; padding: 20px 40px; border-radius: 50px; font-size: 24px; font-weight: 900; cursor: pointer; box-shadow: 0 0 20px #eab308; animation: bounce 1s infinite;">‚ñ∂ TAP TO START</button>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ROBUST AUDIO ENGINE ---
        const synth = window.speechSynthesis;
        let audioCtx = null;

        // 1. Force Wake Up Speech Engine
        const wakeUpSpeech = () => {
            if (!synth) return;
            // Play a silent utterance to wake up the engine on Android
            const u = new SpeechSynthesisUtterance("");
            u.volume = 0;
            synth.speak(u);
        };

        // 2. Initialize Audio Context
        const initAudio = () => {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            wakeUpSpeech();
        };

        // 3. Safe Speak Function with Highlight Fallback
        const speak = (text, onWord, onEnd) => {
            if (!synth) return;
            synth.cancel();

            const u = new SpeechSynthesisUtterance(text);
            u.rate = 0.8; // Slower for kids
            u.pitch = 1.2; // Happy pitch
            u.lang = 'en-US';

            // Attempt to find a good voice
            const voices = synth.getVoices();
            const preferred = voices.find(v => v.name.includes('Google US English') || v.name.includes('Female'));
            if (preferred) u.voice = preferred;

            // TIMING FALLBACK: If the browser doesn't support onboundary correctly
            // we estimate word length to force highlighting.
            let wordIndex = 0;
            const words = text.split(' ');
            let timer = null;
            
            // Official Event
            u.onboundary = (e) => {
                if (e.name === 'word') {
                    // Find which word roughly matches this char index
                    let charCount = 0;
                    for(let i=0; i<words.length; i++) {
                        if (charCount >= e.charIndex) {
                            if (onWord) onWord(i);
                            return;
                        }
                        charCount += words[i].length + 1;
                    }
                }
            };

            u.onstart = () => {
                // Fallback Timer (Safety Net)
                if (!('onboundary' in u)) {
                    const step = () => {
                        if (wordIndex < words.length) {
                            if (onWord) onWord(wordIndex);
                            wordIndex++;
                            // Rough estimate: 400ms per word
                            timer = setTimeout(step, 400 + (words[wordIndex-1].length * 50)); 
                        }
                    };
                    step();
                }
            };

            u.onend = () => {
                clearTimeout(timer);
                if (onEnd) onEnd();
            };

            synth.speak(u);
        };

        const playTone = (freq, type='sine', dur=0.1, vol=0.1) => {
            initAudio(); // Ensure context is ready
            if (!audioCtx) return;
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = type;
            osc.frequency.value = freq;
            
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + dur);
        };

        // --- GAME 1: STORY TIME (Highlighting) ---
        const StoryGame = ({ onBack }) => {
            const [page, setPage] = useState(0);
            const [hlIndex, setHlIndex] = useState(-1);
            
            const pages = [
                { text: "Isla and Evie go on an adventure!", emoji: "üë≠", bg: "bg-blue-100" },
                { text: "They jump in their big black truck. Vroom!", emoji: "üõª", bg: "bg-slate-200" },
                { text: "Juno and Milo run in the grass.", emoji: "üêï", bg: "bg-green-100" },
                { text: "They find eggs in Mama's Coop.", emoji: "ü•ö", bg: "bg-orange-100" },
                { text: "Isla jumps high on the trampoline!", emoji: "ü§∏‚Äç‚ôÄÔ∏è", bg: "bg-blue-200" },
                { text: "Time to sleep. Goodnight sisters!", emoji: "üí§", bg: "bg-indigo-200" }
            ];

            const words = useMemo(() => pages[page].text.split(' '), [page]);

            const handleRead = () => {
                setHlIndex(-1);
                speak(pages[page].text, (idx) => setHlIndex(idx), () => setHlIndex(-1));
            };

            // Auto-read when page loads
            useEffect(() => {
                const t = setTimeout(handleRead, 500);
                return () => { clearTimeout(t); synth.cancel(); };
            }, [page]);

            return (
                <div className={`game-screen ${pages[page].bg} transition-colors duration-700 p-6 flex flex-col items-center text-center`}>
                    <div className="w-full flex justify-between">
                        <button onClick={() => { synth.cancel(); onBack(); }} className="bg-white p-3 rounded-full shadow-lg text-xl z-20">‚¨Ö Exit</button>
                        <button onClick={handleRead} className="bg-yellow-400 p-3 rounded-full shadow-lg animate-pulse text-3xl z-20">üîä</button>
                    </div>
                    
                    <div className="flex-grow flex flex-col justify-center items-center">
                        <div className="text-[180px] emoji-3d mb-8">{pages[page].emoji}</div>
                        <div className="bg-white/90 p-8 rounded-3xl shadow-xl max-w-3xl border-4 border-white">
                            <p className="text-4xl font-bold text-slate-800 leading-relaxed">
                                {words.map((w, i) => (
                                    <span key={i} className={`word-span ${i === hlIndex ? 'word-active' : ''}`}>
                                        {w}{' '}
                                    </span>
                                ))}
                            </p>
                        </div>
                    </div>

                    <div className="w-full flex gap-6 mt-4 max-w-2xl z-20">
                        {page > 0 && <button onClick={() => setPage(p=>p-1)} className="btn-3d flex-1 bg-white text-slate-600 py-5 rounded-2xl font-bold text-2xl">Back</button>}
                        <button onClick={() => page < pages.length-1 ? setPage(p=>p+1) : onBack()} className="btn-3d flex-[2] bg-green-500 text-white py-4 rounded-2xl font-bold text-2xl border-b-4 border-green-700">
                            {page < pages.length-1 ? "Next Page ‚û°Ô∏è" : "Finish! üåü"}
                        </button>
                    </div>
                </div>
            );
        };

        // --- GAME 2: COOKIE MATH ---
        const MathGame = ({ onBack }) => {
            const [p, setP] = useState({ a: 1, b: 1 });
            const [msg, setMsg] = useState("Count the Cookies!");
            
            const gen = () => {
                setP({ a: Math.ceil(Math.random()*3), b: Math.ceil(Math.random()*3) });
                setMsg("Count the Cookies!");
            };

            const check = (ans) => {
                if (ans === p.a + p.b) {
                    setMsg("Correct! üéâ");
                    playTone(600, 'sine', 0.1);
                    playTone(800, 'sine', 0.2);
                    setTimeout(gen, 1500);
                } else {
                    setMsg("Try Again!");
                    playTone(150, 'sawtooth', 0.3);
                }
            };

            return (
                <div className="game-screen bg-sky-100 p-4 flex flex-col items-center">
                    <button onClick={onBack} className="self-start bg-white p-3 rounded-full shadow mb-4">‚¨Ö Exit</button>
                    
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md text-center mb-8 border-4 border-sky-200">
                        <h2 className="text-2xl font-bold text-sky-700 mb-4">{msg}</h2>
                        <div className="flex justify-center items-center gap-4 text-5xl mb-6">
                            <div className="bg-sky-50 p-4 rounded-xl border-2 border-sky-200">{Array(p.a).fill('üç™').join('')}</div>
                            <div className="text-slate-400">+</div>
                            <div className="bg-sky-50 p-4 rounded-xl border-2 border-sky-200">{Array(p.b).fill('üç™').join('')}</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-3 gap-4 w-full max-w-md">
                        {[2,3,4,5,6].map(n => (
                            <button key={n} onClick={() => check(n)} className="btn-3d bg-white text-sky-600 text-4xl font-bold py-6 rounded-2xl shadow border-b-4 border-slate-200">
                                {n}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- GAME 3: FLASH CARDS ---
        const FlashGame = ({ onBack }) => {
            const cards = [
                {w:"Isla", e:"üëß", c:"bg-pink-100"}, {w:"Evie", e:"üë∂", c:"bg-purple-100"}, 
                {w:"Truck", e:"üõª", c:"bg-slate-300"}, {w:"Ball", e:"‚öΩ", c:"bg-white"},
                {w:"Dog", e:"üêï", c:"bg-orange-100"}, {w:"Cat", e:"üêà", c:"bg-yellow-100"},
                {w:"Moon", e:"üåô", c:"bg-indigo-200"}, {w:"Sun", e:"‚òÄÔ∏è", c:"bg-yellow-100"},
                {w:"Apple", e:"üçé", c:"bg-red-200"}, {w:"Cookie", e:"üç™", c:"bg-amber-200"}
            ];
            const [i, setI] = useState(0);

            const play = () => { speak(cards[i].w); };
            useEffect(() => { setTimeout(play, 500); }, [i]);

            return (
                <div className={`game-screen ${cards[i].c} transition-colors duration-500 p-6 flex flex-col items-center`}>
                    <div className="w-full flex justify-between">
                        <button onClick={onBack} className="bg-white p-3 rounded-full shadow text-xl z-20">‚¨Ö Exit</button>
                        <button onClick={play} className="bg-white text-purple-600 p-3 rounded-full shadow text-3xl z-20">üîä</button>
                    </div>
                    
                    <div onClick={play} className="flex-grow flex flex-col justify-center items-center cursor-pointer w-full">
                        <div className="bg-white/90 rounded-[50px] shadow-2xl border-8 border-white w-full max-w-md aspect-square flex flex-col items-center justify-center p-4 active:scale-95 transition-transform">
                            <div className="text-[200px] mb-4 emoji-3d leading-none">{cards[i].e}</div>
                            <div className="text-7xl font-black text-slate-800 tracking-wider">{cards[i].w}</div>
                        </div>
                        <div className="mt-6 text-slate-600 font-bold opacity-50 text-xl">Tap card to hear</div>
                    </div>

                    <div className="w-full flex gap-4 mt-4 max-w-md z-20">
                        <button onClick={() => setI(prev => prev === 0 ? cards.length - 1 : prev - 1)} className="btn-3d flex-1 bg-white text-slate-600 py-6 rounded-2xl font-bold text-3xl">‚¨Ö</button>
                        <button onClick={() => setI(prev => (prev + 1) % cards.length)} className="btn-3d flex-[2] bg-indigo-500 text-white text-2xl font-bold py-6 rounded-2xl border-b-8 border-indigo-700">Next ‚û°Ô∏è</button>
                    </div>
                </div>
            );
        };

        // --- GAME 4: GABBA FREEZE DANCE ---
        const GabbaGame = ({ onBack }) => {
            const [dancing, setDancing] = useState(false);
            const intervalRef = useRef(null);

            const startMusic = () => {
                initAudio(); // Wakes audio
                setDancing(true);
                let beat = 0;
                if (intervalRef.current) clearInterval(intervalRef.current);
                intervalRef.current = setInterval(() => {
                    if (beat % 4 === 0) playTone(100, 'square', 0.1, 0.3); // Kick
                    if (beat % 4 === 2) playTone(200, 'sawtooth', 0.1, 0.2); // Snare
                    playTone(800, 'triangle', 0.05, 0.1); // Hat
                    beat++;
                }, 400);
            };

            const stopMusic = () => {
                setDancing(false);
                if (intervalRef.current) clearInterval(intervalRef.current);
            };

            useEffect(() => () => stopMusic(), []);

            const chars = [
                { c: "üî¥", bg: "bg-red-200", anim: "d-jump" },
                { c: "üå∏", bg: "bg-pink-200", anim: "d-spin" },
                { c: "ü•¶", bg: "bg-green-200", anim: "d-wiggle" },
                { c: "ü•∂", bg: "bg-blue-200", anim: "d-stretch" },
                { c: "ü§ñ", bg: "bg-yellow-200", anim: "d-jump" }
            ];

            return (
                <div className={`game-screen transition-colors duration-500 flex flex-col ${dancing ? 'bg-slate-900' : 'bg-orange-50'}`}>
                    <div className="p-4 flex justify-between z-20">
                        <button onClick={onBack} className="bg-white p-3 rounded-full shadow text-xl">‚¨Ö Exit</button>
                        <button 
                            onClick={dancing ? stopMusic : startMusic}
                            className={`px-8 py-4 rounded-full font-black shadow-xl transition-all text-2xl ${dancing ? 'bg-red-500 text-white scale-110' : 'bg-gre
